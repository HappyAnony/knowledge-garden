/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var Z=Object.defineProperty;var he=Object.getOwnPropertyDescriptor;var ue=Object.getOwnPropertyNames;var pe=Object.prototype.hasOwnProperty;var ge=(p,e)=>{for(var t in e)Z(p,t,{get:e[t],enumerable:!0})},fe=(p,e,t,i)=>{if(e&&typeof e=="object"||typeof e=="function")for(let r of ue(e))!pe.call(p,r)&&r!==t&&Z(p,r,{get:()=>e[r],enumerable:!(i=he(e,r))||i.enumerable});return p};var me=p=>fe(Z({},"__esModule",{value:!0}),p);var _e={};ge(_e,{default:()=>J});module.exports=me(_e);var P=require("obsidian");var ee=require("obsidian");var X=require("obsidian");var _=class{constructor(e){this.app=e}removeMarkdownFormatting(e){return e&&(e=e.replace(/\*\*(.*?)\*\*/g,"$1").replace(/__(.*?)__/g,"$1"),e=e.replace(/\*(.*?)\*/g,"$1").replace(/_(.*?)_/g,"$1"),e=e.replace(/`(.*?)`/g,"$1"),e=e.replace(/~~(.*?)~~/g,"$1"),e=e.replace(/==(.*?)==/g,"$1"),e=e.replace(/\[(.*?)\]\(.*?\)/g,"$1"),e.trim())}async parseCanvasFile(e){try{let t=await this.app.vault.read(e),i=JSON.parse(t),r=i.nodes.find(s=>s.type==="group"&&(s.label==="Mastered"||s.label==="\u5DF2\u638C\u63E1")),o=[];for(let s of i.nodes)if(s.type==="text"&&s.text){let a=this.parseTextNode(s,e.path);a&&(r&&this.isNodeInGroup(s,r)&&(a.mastered=!0),o.push(a))}return o}catch(t){return console.error(`Failed to parse canvas file ${e.path}:`,t),[]}}parseTextNode(e,t){if(!e.text)return null;let i=e.text.trim(),r="",o=[],s="";try{let a=i.split(`
`);if(a.length===0||(r=a[0].replace(/^#+\s*/,"").trim(),r=this.removeMarkdownFormatting(r),!r))return null;if(a.length>1){let d=-1,h=-1;for(let u=1;u<a.length;u++){let l=a[u].trim();if(l.startsWith("*")&&l.endsWith("*")&&l.length>2){let g=l.slice(1,-1).split(",").map(w=>w.trim()).filter(w=>w);o.push(...g),d=u}else if(l!==""){h=u;break}}if(h>0&&h<a.length){for(;h<a.length&&a[h].trim()==="";)h++;h<a.length&&(s=a.slice(h).join(`
`).trim())}else d===-1&&(s=a.slice(1).join(`
`).trim())}return r?{word:r.toLowerCase(),aliases:o.length>0?o:void 0,definition:s,source:t,nodeId:e.id,color:e.color}:null}catch(a){return console.error(`\u89E3\u6790\u8282\u70B9\u6587\u672C\u65F6\u51FA\u9519: ${a}`),null}}static isCanvasFile(e){return e.extension==="canvas"}async validateCanvasFile(e){try{let t=await this.app.vault.read(e),i=JSON.parse(t);return Array.isArray(i.nodes)&&Array.isArray(i.edges)}catch(t){return!1}}isNodeInGroup(e,t){if(typeof e.x!="number"||typeof e.y!="number"||typeof e.width!="number"||typeof e.height!="number"||typeof t.x!="number"||typeof t.y!="number"||typeof t.width!="number"||typeof t.height!="number")return!1;let i=e.x,r=e.x+e.width,o=e.y,s=e.y+e.height,a=t.x,c=t.x+t.width,d=t.y,h=t.y+t.height;if(!(i>=a&&r<=c&&o>=d&&s<=h)){if(i<c&&r>a&&o<h&&s>d){let f=Math.max(i,a),g=Math.min(r,c),w=Math.max(o,d),M=Math.min(s,h),E=(g-f)*(M-w),v=e.width*e.height;return E>=v*.5}return!1}return!0}};var L=class{constructor(e){this.app=e}async addWordToCanvas(e,t,i,r,o){try{let s=this.app.vault.getAbstractFileByPath(e);if(!s||!(s instanceof X.TFile)||!_.isCanvasFile(s))return console.error(`\u65E0\u6548\u7684 Canvas \u6587\u4EF6: ${e}`),!1;o&&(o=o.filter(g=>g&&g.trim().length>0),o.length===0&&(o=void 0));let a=await this.app.vault.read(s),c=JSON.parse(a);if(!Array.isArray(c.nodes))return console.error(`\u65E0\u6548\u7684 Canvas \u6570\u636E: ${e}`),!1;let d=`node-${Date.now()}-${Math.floor(Math.random()*1e3)}`,h=0,u=0;if(c.nodes.length>0){let g=c.nodes[c.nodes.length-1];h=g.x,u=g.y+g.height+50}let l=t;o&&o.length>0&&(l=`${t}
*${o.join(", ")}*`),i&&(l=`${l}

${i}`);let f={id:d,type:"text",x:h,y:u,width:360,height:160,text:l,color:r!==void 0?r.toString():void 0};return c.nodes.push(f),await this.app.vault.modify(s,JSON.stringify(c)),!0}catch(s){return console.error(`\u6DFB\u52A0\u8BCD\u6C47\u5230 Canvas \u5931\u8D25: ${s}`),!1}}async updateWordInCanvas(e,t,i,r,o,s){try{let a=this.app.vault.getAbstractFileByPath(e);if(!a||!(a instanceof X.TFile)||!_.isCanvasFile(a))return console.error(`\u65E0\u6548\u7684 Canvas \u6587\u4EF6: ${e}`),!1;s&&(s=s.filter(l=>l&&l.trim().length>0),s.length===0&&(s=void 0));let c=await this.app.vault.read(a),d=JSON.parse(c);if(!Array.isArray(d.nodes))return console.error(`\u65E0\u6548\u7684 Canvas \u6570\u636E: ${e}`),!1;let h=d.nodes.findIndex(l=>l.id===t);if(h===-1)return console.error(`\u672A\u627E\u5230\u8282\u70B9: ${t}`),!1;let u=i;return s&&s.length>0&&(u=`${i}
*${s.join(", ")}*`),r&&(u=`${u}

${r}`),d.nodes[h].text=u,o!==void 0&&(d.nodes[h].color=o.toString()),await this.app.vault.modify(a,JSON.stringify(d)),!0}catch(a){return console.error(`\u66F4\u65B0 Canvas \u4E2D\u7684\u8BCD\u6C47\u5931\u8D25: ${a}`),!1}}async deleteWordFromCanvas(e,t){try{let i=this.app.vault.getAbstractFileByPath(e);if(!i||!(i instanceof X.TFile)||!_.isCanvasFile(i))return console.error(`\u65E0\u6548\u7684 Canvas \u6587\u4EF6: ${e}`),!1;let r=await this.app.vault.read(i),o=JSON.parse(r);if(!Array.isArray(o.nodes))return console.error(`Canvas \u6587\u4EF6\u683C\u5F0F\u65E0\u6548: ${e}`),!1;let s=o.nodes.findIndex(a=>a.id===t);return s===-1?(console.warn(`\u672A\u627E\u5230\u8981\u5220\u9664\u7684\u8282\u70B9: ${t}`),!1):(o.nodes.splice(s,1),await this.app.vault.modify(i,JSON.stringify(o)),!0)}catch(i){return console.error(`\u4ECE Canvas \u4E2D\u5220\u9664\u8BCD\u6C47\u5931\u8D25: ${i}`),!1}}};var Q=require("obsidian");var $=class{constructor(e){this.MASTERED_GROUP_LABEL="Mastered";this.MASTERED_GROUP_COLOR="4";this.app=e,this.canvasParser=new _(e)}async ensureMasteredGroup(e){try{let t=await this.loadCanvas(e);if(!t)return null;let i=t.nodes.find(r=>r.type==="group"&&r.label===this.MASTERED_GROUP_LABEL);return i||(i=this.createMasteredGroup(t),t.nodes.unshift(i),await this.saveCanvas(e,t)),i.id}catch(t){return null}}async moveToMasteredGroup(e,t){try{let i=await this.ensureMasteredGroup(e);if(!i)return!1;let r=await this.loadCanvas(e);if(!r)return!1;let o=r.nodes.find(c=>c.id===t),s=r.nodes.find(c=>c.id===i);return!o||!s||!await this.moveNodeToGroupOptimized(o,s,r)?!1:(await this.saveCanvas(e,r),!0)}catch(i){return!1}}async removeFromMasteredGroup(e,t){try{let i=await this.loadCanvas(e);if(!i)return!1;let r=i.nodes.find(s=>s.id===t);return!r||!i.nodes.find(s=>s.type==="group"&&s.label===this.MASTERED_GROUP_LABEL)?!1:(await this.moveNodeOutOfGroup(r,i),await this.saveCanvas(e,i),!0)}catch(i){return!1}}async isNodeInMasteredGroup(e,t){try{let i=await this.loadCanvas(e);if(!i)return!1;let r=i.nodes.find(s=>s.id===t);if(!r)return!1;let o=i.nodes.find(s=>s.type==="group"&&s.label===this.MASTERED_GROUP_LABEL);return o?this.canvasParser.isNodeInGroup(r,o):!1}catch(i){return!1}}createMasteredGroup(e){let t=`group-${Date.now()}-${Math.floor(Math.random()*1e3)}`,{x:i,y:r}=this.calculateMasteredGroupPosition(e);return{id:t,type:"group",x:i,y:r,width:400,height:200,color:this.MASTERED_GROUP_COLOR,label:this.MASTERED_GROUP_LABEL}}calculateMasteredGroupPosition(e){let t=e.nodes.filter(l=>l.type==="text"||l.type==="group");if(t.length===0)return{x:50,y:50};let i=Math.min(...t.map(l=>l.x)),r=Math.max(...t.map(l=>l.x+(l.width||200))),o=Math.min(...t.map(l=>l.y)),s=Math.max(...t.map(l=>l.y+(l.height||100))),a=800,c=600,d=50,h=r+d,u=o;return h+a>3e3&&(h=i,u=s+d),{x:h,y:u}}async moveNodeToGroupOptimized(e,t,i){try{let r=this.prepareNodePlacement(e,t,i);return r.success?this.executeNodePlacement(e,t,i,r):!1}catch(r){return!1}}prepareNodePlacement(e,t,i){let r=this.getGroupMembers(t,i,e.id),o=this.calculateSafePosition(e,t,r),s=this.calculateNewGroupBounds(t,r,{...e,x:o.x,y:o.y});return{success:!0,existingMembers:r,safePosition:o,newGroupBounds:s,error:null}}executeNodePlacement(e,t,i,r){try{if(this.updateGroupBounds(t,r.newGroupBounds),e.x=r.safePosition.x,e.y=r.safePosition.y,!this.canvasParser.isNodeInGroup(e,t)){let s=this.correctNodePosition(e,t);if(e.x=s.x,e.y=s.y,!this.canvasParser.isNodeInGroup(e,t))return!1}return this.adjustGroupSizeToFitContent(t,i),!0}catch(o){return!1}}async adjustNodePositionInGroup(e,t,i){let r=i.nodes.find(o=>o.id===t);r&&await this.moveNodeToGroupOptimized(e,r,i)}async moveNodeOutOfGroup(e,t){let i=t.nodes.find(l=>l.type==="group"&&l.label===this.MASTERED_GROUP_LABEL),r=t.nodes.filter(l=>l.type!=="text"||l.id===e.id?!1:i?!this.canvasParser.isNodeInGroup(l,i):!0),o=50,s=e.width||200,a=e.height||60;if(r.length===0){e.x=o,e.y=o;return}let c=Math.min(...r.map(l=>l.x)),d=Math.max(...r.map(l=>l.x+(l.width||200))),h=Math.min(...r.map(l=>l.y)),u=Math.max(...r.map(l=>l.y+(l.height||60)));if(e.x=c,e.y=u+o,i){let l=i.y+i.height;e.y<l+o&&(e.y=l+o)}}adjustGroupSizeToFitContent(e,t){let i=t.nodes.filter(g=>g.type==="text"&&this.canvasParser.isNodeInGroup(g,e));if(i.length===0){e.width=Math.max(e.width,300),e.height=Math.max(e.height,150);return}let r=30,o=i.map(g=>({left:g.x,right:g.x+(g.width||200),top:g.y,bottom:g.y+(g.height||60)})),s=Math.min(...o.map(g=>g.left)),a=Math.max(...o.map(g=>g.right)),c=Math.min(...o.map(g=>g.top)),d=Math.max(...o.map(g=>g.bottom)),h=a-s+2*r,u=d-c+2*r,l=s-r,f=c-r;e.x=l,e.y=f,e.width=Math.max(h,300),e.height=Math.max(u,150)}getGroupMembers(e,t,i){return t.nodes.filter(r=>r.id!==e.id&&r.id!==i&&r.type!=="group"&&this.canvasParser.isNodeInGroup(r,e))}calculateSafePosition(e,t,i){let r=e.width||250,o=e.height||150,s=30,a=20,c=t.x+s,d=t.y+s,h=t.width-2*s,u=t.height-2*s,l=r+2*s,f=o+2*s;if(h<r||u<o)return this.calculatePositionWithGroupExpansion(e,t,i);let g=Math.floor(h/(r+a));for(let w=0;w<20;w++)for(let M=0;M<Math.max(1,g);M++){let E=c+M*(r+a),v=d+w*(o+a);if(E+r>t.x+t.width-s||v+o>t.y+t.height-s)continue;if(!i.some(S=>this.nodesOverlap({x:E,y:v,width:r,height:o},S)))return{x:E,y:v}}return this.calculatePositionWithGroupExpansion(e,t,i)}calculatePositionWithGroupExpansion(e,t,i){let r=e.width||250,o=e.height||150,s=30,a=20;if(i.length===0)return{x:t.x+s,y:t.y+s};let c=Math.max(...i.map(u=>u.x+(u.width||250))),d=Math.max(...i.map(u=>u.y+(u.height||150))),h=c+a;if(h+r<=t.x+t.width-s){let u=Math.min(...i.map(l=>l.y));return{x:h,y:u}}return{x:t.x+s,y:d+a}}nodesOverlap(e,t){let i=e.x+e.width,r=e.y+e.height,o=t.x+(t.width||250),s=t.y+(t.height||150);return!(e.x>=o||i<=t.x||e.y>=s||r<=t.y)}calculateNewGroupBounds(e,t,i){let r=[...t,i],o=30;if(r.length===0)return{x:e.x,y:e.y,width:Math.max(e.width,300),height:Math.max(e.height,200)};let s=Math.min(...r.map(h=>h.x)),a=Math.min(...r.map(h=>h.y)),c=Math.max(...r.map(h=>h.x+(h.width||250))),d=Math.max(...r.map(h=>h.y+(h.height||150)));return{x:s-o,y:a-o,width:c-s+2*o,height:d-a+2*o}}updateGroupBounds(e,t){e.x=t.x,e.y=t.y,e.width=Math.max(t.width,300),e.height=Math.max(t.height,200)}correctNodePosition(e,t){let i=e.width||250,r=e.height||150,o=30,s=Math.max(t.x+o,Math.min(e.x,t.x+t.width-i-o)),a=Math.max(t.y+o,Math.min(e.y,t.y+t.height-r-o));return{x:s,y:a}}async loadCanvas(e){try{let t=this.app.vault.getAbstractFileByPath(e);if(!(t instanceof Q.TFile))return null;let i=await this.app.vault.read(t);return JSON.parse(i)}catch(t){return null}}async saveCanvas(e,t){try{let i=this.app.vault.getAbstractFileByPath(e);return i instanceof Q.TFile?(await this.app.vault.modify(i,JSON.stringify(t)),!0):!1}catch(i){return!1}}};var I=class{constructor(e,t){this.definitions=new Map;this.wordDefinitionCache=new Map;this.allWordsCache=[];this.bookWordsCache=new Map;this.cacheValid=!1;this.memoryOnlyWords=new Map;this.pendingSyncWords=new Map;this.syncTimeouts=new Map;this.tempNodeIdCounter=0;this.app=e,this.canvasParser=new _(e),this.canvasEditor=new L(e),this.settings=t}async loadAllVocabularyBooks(){let e=performance.now();this.definitions.clear(),this.invalidateCache();let t=this.settings.vocabularyBooks.filter(r=>r.enabled).map(r=>this.loadVocabularyBook(r));await Promise.all(t),this.rebuildCache();let i=performance.now()}async loadVocabularyBook(e){let t=performance.now(),i=this.app.vault.getAbstractFileByPath(e.path);if(!i||!(i instanceof ee.TFile)){console.warn(`Canvas file not found: ${e.path}`);return}if(!_.isCanvasFile(i)){console.warn(`File is not a canvas: ${e.path}`);return}try{let r=await this.canvasParser.parseCanvasFile(i);this.definitions.set(e.path,r),this.invalidateCache();let o=performance.now()}catch(r){console.error(`Failed to load vocabulary book ${e.name}:`,r)}}getDefinition(e,t=new Set){let i=e.toLowerCase().trim();if(t.has(i))return null;if(t.add(i),this.cacheValid&&this.wordDefinitionCache.has(i))return this.wordDefinitionCache.get(i)||null;if(!this.cacheValid&&(this.rebuildCache(),this.wordDefinitionCache.has(i)))return this.wordDefinitionCache.get(i)||null;for(let r of this.definitions.values()){let o=r.find(a=>a.word===i);if(o)return this.wordDefinitionCache.set(i,o),o;let s=r.find(a=>a.aliases&&a.aliases.includes(i));if(s)return this.wordDefinitionCache.set(i,s),s}return null}getAllWords(){return this.cacheValid?[...this.allWordsCache]:(this.rebuildCache(),[...this.allWordsCache])}getAllWordsForHighlight(){if(!this.settings.enableMasteredFeature)return this.getAllWords();if(this.cacheValid){let t=[];for(let i of this.allWordsCache){let r=this.wordDefinitionCache.get(i);r&&!r.mastered&&t.push(i)}return t}this.rebuildCache();let e=[];for(let t of this.allWordsCache){let i=this.wordDefinitionCache.get(t);i&&!i.mastered&&e.push(t)}return e}getWordsFromBook(e){if(this.cacheValid&&this.bookWordsCache.has(e))return[...this.bookWordsCache.get(e)];let t=this.definitions.get(e);if(!t)return[];let i=[];i.push(...t.map(o=>o.word)),t.forEach(o=>{o.aliases&&o.aliases.length>0&&i.push(...o.aliases)});let r=[...new Set(i)];return this.bookWordsCache.set(e,r),r}async reloadVocabularyBook(e){let t=this.settings.vocabularyBooks.find(i=>i.path===e);t&&t.enabled&&(await this.loadVocabularyBook(t),this.invalidateCache())}updateSettings(e){this.settings=e,this.invalidateCache()}getSettings(){return this.settings}getStats(){let e=this.settings.vocabularyBooks.length,t=this.settings.vocabularyBooks.filter(r=>r.enabled).length,i=0;for(let r of this.definitions.values())i+=r.length;return{totalBooks:e,enabledBooks:t,totalWords:i}}hasWord(e){let t=e.toLowerCase().trim();return this.cacheValid?this.wordDefinitionCache.has(t):this.getDefinition(e)!==null}clear(){this.definitions.clear(),this.invalidateCache()}async addWordToCanvas(e,t,i,r,o){try{let s={word:t,definition:i,source:e,nodeId:this.generateTempNodeId(),color:r?this.getColorString(r):void 0,aliases:o==null?void 0:o.filter(a=>a&&a.trim().length>0)};return this.addWordToMemoryCache(e,s),this.rebuildCache(),this.scheduleCanvasSync(e,s),!0}catch(s){return console.error("Failed to add word to canvas:",s),!1}}invalidateCache(){this.cacheValid=!1,this.wordDefinitionCache.clear(),this.allWordsCache=[],this.bookWordsCache.clear()}rebuildCache(){let e=performance.now();this.wordDefinitionCache.clear(),this.allWordsCache=[],this.bookWordsCache.clear();let t=new Set;for(let[i,r]of this.definitions.entries()){let o=new Set;for(let s of r){let a=s.word.toLowerCase().trim();if(this.wordDefinitionCache.set(a,s),t.add(a),o.add(a),s.aliases&&s.aliases.length>0)for(let c of s.aliases){let d=c.toLowerCase().trim();this.wordDefinitionCache.set(d,s),t.add(d),o.add(d)}}this.bookWordsCache.set(i,[...o])}this.allWordsCache=[...t],this.cacheValid=!0}async updateWordInCanvas(e,t,i,r,o,s){try{if(await this.canvasEditor.updateWordInCanvas(e,t,i,r,o,s)){let c={word:i,definition:r,source:e,nodeId:t,color:o?this.getColorString(o):void 0,aliases:s==null?void 0:s.filter(d=>d&&d.trim().length>0)};return this.updateWordInMemoryCache(e,t,c),this.rebuildCache(),!0}return!1}catch(a){return console.error("Failed to update word in canvas:",a),!1}}generateTempNodeId(){return`temp_${Date.now()}_${++this.tempNodeIdCounter}`}getColorString(e){return e>=1&&e<=6?e.toString():void 0}addWordToMemoryCache(e,t){let i=this.definitions.get(e);i||(i=[],this.definitions.set(e,i));let r=i.findIndex(o=>o.word===t.word);r>=0?i[r]=t:i.push(t),this.wordDefinitionCache.set(t.word,t),t.aliases&&t.aliases.forEach(o=>{this.wordDefinitionCache.set(o,t)}),this.cacheValid=!1}updateWordInMemoryCache(e,t,i){let r=this.definitions.get(e);if(!r){console.warn(`\u672A\u627E\u5230\u4E66\u672C: ${e}`);return}let o=r.findIndex(s=>s.nodeId===t);if(o>=0){let s=r[o];this.wordDefinitionCache.delete(s.word),s.aliases&&s.aliases.forEach(a=>{this.wordDefinitionCache.delete(a)}),r[o]=i,this.wordDefinitionCache.set(i.word,i),i.aliases&&i.aliases.forEach(a=>{this.wordDefinitionCache.set(a,i)}),this.cacheValid=!1}else console.warn(`\u672A\u627E\u5230\u8282\u70B9ID: ${t}`)}scheduleCanvasSync(e,t){let i=this.syncTimeouts.get(e);i&&clearTimeout(i),this.pendingSyncWords.has(e)||this.pendingSyncWords.set(e,[]),this.pendingSyncWords.get(e).push(t);let r=setTimeout(()=>{this.syncPendingWords(e)},1e3);this.syncTimeouts.set(e,r)}async syncPendingWords(e){let t=this.pendingSyncWords.get(e);if(!(!t||t.length===0))try{for(let i of t)await this.canvasEditor.addWordToCanvas(e,i.word,i.definition,i.color?this.getColorNumber(i.color):void 0,i.aliases)&&(i.nodeId=`node_${Date.now()}_${Math.random().toString(36).substr(2,9)}`);this.pendingSyncWords.delete(e),this.syncTimeouts.delete(e)}catch(i){console.error("Failed to sync words to canvas:",i)}}getColorNumber(e){let t=parseInt(e,10);return t>=1&&t<=6?t:0}invalidateCacheForBook(e){let t=this.definitions.get(e);t&&t.forEach(i=>{this.wordDefinitionCache.delete(i.word),i.aliases&&i.aliases.forEach(r=>{this.wordDefinitionCache.delete(r)})}),this.cacheValid=!1}async deleteWordFromCanvas(e,t){try{return await this.canvasEditor.deleteWordFromCanvas(e,t)?(this.deleteWordFromMemoryCache(e,t),this.rebuildCache(),!0):!1}catch(i){return console.error("Failed to delete word from canvas:",i),!1}}deleteWordFromMemoryCache(e,t){let i=this.definitions.get(e);if(!i){console.warn(`\u672A\u627E\u5230\u4E66\u672C: ${e}`);return}let r=i.findIndex(o=>o.nodeId===t);if(r>=0){let o=i[r];this.wordDefinitionCache.delete(o.word),o.aliases&&o.aliases.forEach(a=>{this.wordDefinitionCache.delete(a)}),i.splice(r,1);let s=this.memoryOnlyWords.get(e);if(s){let a=s.findIndex(c=>c.nodeId===t);a>=0&&(s.splice(a,1),s.length===0&&this.memoryOnlyWords.delete(e))}this.cacheValid=!1}else console.warn(`\u672A\u627E\u5230\u8282\u70B9ID: ${t}`)}destroy(){this.syncTimeouts.forEach(e=>clearTimeout(e)),this.syncTimeouts.clear(),this.definitions.clear(),this.wordDefinitionCache.clear(),this.allWordsCache=[],this.bookWordsCache.clear(),this.memoryOnlyWords.clear(),this.pendingSyncWords.clear()}async getWordDefinitionByNodeId(e,t){let i=this.definitions.get(e);return i&&i.find(o=>o.nodeId===t)||null}async updateWordDefinition(e,t,i){let r=this.definitions.get(e);if(!r)return!1;let o=r.findIndex(a=>a.nodeId===t);if(o===-1)return!1;let s=r[o];r[o]=i,this.wordDefinitionCache.delete(s.word),s.aliases&&s.aliases.forEach(a=>this.wordDefinitionCache.delete(a)),this.wordDefinitionCache.set(i.word,i),i.aliases&&i.aliases.forEach(a=>this.wordDefinitionCache.set(a,i)),this.cacheValid=!1;try{await this.saveWordDefinitionToCanvas(e,t,i)}catch(a){console.error("\u4FDD\u5B58\u5355\u8BCD\u5B9A\u4E49\u5230 Canvas \u5931\u8D25:",a)}return!0}async saveWordDefinitionToCanvas(e,t,i){let r=this.app.vault.getAbstractFileByPath(e);if(!(r instanceof ee.TFile))throw new Error(`Canvas \u6587\u4EF6\u4E0D\u5B58\u5728: ${e}`);try{let o=await this.app.vault.read(r),s=JSON.parse(o),a=s.nodes.find(d=>d.id===i.nodeId);if(!a)throw new Error(`\u627E\u4E0D\u5230\u8282\u70B9 ID: ${i.nodeId}`);let c=i.word;i.aliases&&i.aliases.length>0&&(c+=`
*${i.aliases.join(", ")}*`),i.definition&&(c+=`
`+i.definition),a.text=c,await this.app.vault.modify(r,JSON.stringify(s))}catch(o){throw console.error("\u4FDD\u5B58 Canvas \u6587\u4EF6\u5931\u8D25:",o),o}}async getAllWordDefinitions(){let e=[];for(let t of this.definitions.values())e.push(...t);for(let t of this.memoryOnlyWords.values())e.push(...t);return e}async getWordDefinitionsByBook(e){let t=this.definitions.get(e)||[],i=this.memoryOnlyWords.get(e)||[];return[...t,...i]}async getUnmasteredWords(){this.cacheValid||this.rebuildCache();let e=[];for(let t of this.allWordsCache){let i=this.wordDefinitionCache.get(t);i&&!i.mastered&&e.push(t)}return e}async getMasteredWords(){this.cacheValid||this.rebuildCache();let e=[];for(let t of this.allWordsCache){let i=this.wordDefinitionCache.get(t);i&&i.mastered&&e.push(t)}return e}isWordMastered(e){let t=this.wordDefinitionCache.get(e.toLowerCase());return(t==null?void 0:t.mastered)===!0}};var C=require("obsidian");var ae={plugin_name:"HiWords",settings:{vocabulary_books:"Word books",add_vocabulary_book:"Add word book",remove_vocabulary_book:"Remove",show_definition_on_hover:"Show definition on hover",show_definition_on_hover_desc:"Show word definition when hovering over highlighted words",enable_auto_highlight:"Enable auto highlight",enable_auto_highlight_desc:"Automatically highlight words from vocabulary books while reading",highlight_style:"Highlight style",highlight_style_desc:"Choose how words are highlighted in text",style_underline:"Underline",style_background:"Background",style_bold:"Bold",style_dotted:"Dotted underline",style_wavy:"Wavy underline",save_settings:"Save settings",no_vocabulary_books:"No vocabulary books yet. Please add a Canvas file as a vocabulary book.",path:"Path",reload_book:"Reload this word book",statistics:"Statistics",total_books:"Total word books: {0}",enabled_books:"Enabled word books: {0}",total_words:"Total words: {0}",enable_mastered_feature:"Enable mastered feature",enable_mastered_feature_desc:"Mark mastered words to stop highlighting them. Sidebar shows grouped words",blur_definitions:"Blur content",blur_definitions_desc:"Blur content by default, reveal on hover. Great for learning\u2014recall before seeing the answer"},sidebar:{title:"HiWords",empty_state:"No words found. Add words to your vocabulary books to see them here.",source_prefix:"From: ",found:"Found",words:"words",no_definition:"No definition available.",vocabulary_book:"Words",mastered:"Mastered",no_learning_words:"No words to learn",no_mastered_words:"No mastered words"},commands:{refresh_vocabulary:"Refresh vocabulary",add_word:"HiWords: Add word",edit_word:"HiWords: Edit word",show_sidebar:"Show HiWords sidebar"},notices:{vocabulary_refreshed:"Vocabulary books refreshed",word_added:"Word added to vocabulary book",word_exists:"Word already exists in vocabulary book",error_adding_word:"Error adding word to vocabulary book",select_book_required:"Please select a vocabulary book",adding_word:"Adding word to vocabulary book...",updating_word:"Updating word...",word_added_success:'Word "{0}" successfully added to vocabulary book',word_updated_success:'Word "{0}" successfully updated',add_word_failed:"Failed to add word, please check the vocabulary book file",update_word_failed:"Failed to update word, please check the vocabulary book file",error_processing_word:"Error processing word",no_canvas_files:"No Canvas files found",book_already_exists:"This vocabulary book already exists",invalid_canvas_file:"Invalid Canvas file",book_added:"Added vocabulary book: {0}",book_reloaded:"Reloaded vocabulary book: {0}",book_removed:"Removed vocabulary book: {0}",deleting_word:"Deleting word...",word_deleted:"Word deleted",delete_word_failed:"Failed to delete word, please check the vocabulary book file",error_deleting_word:"Error occurred while deleting word",mastered_feature_disabled:"Mastered feature is not enabled",update_word_status_failed:"Failed to update word status",move_to_mastered_group_failed:"Failed to move to mastered group",word_marked_as_mastered:'"{0}" marked as mastered',mark_mastered_failed:"Failed to mark as mastered, please try again",remove_from_mastered_group_failed:"Failed to remove from mastered group",word_unmarked_as_mastered:'"{0}" unmarked as mastered',unmark_mastered_failed:"Failed to unmark as mastered, please try again",batch_marked_success:"Successfully marked {0} words as mastered"},modals:{add_word_title:"Add ",edit_word_title:"Edit ",word_label:"Word",definition_label:"Definition",book_label:"Vocabulary book",select_book:"Select a vocabulary book",color_label:"Card color",color_gray:"Gray",color_red:"Red",color_orange:"Orange",color_yellow:"Yellow",color_green:"Green",color_blue:"Blue",color_purple:"Purple",aliases_label:"Aliases (optional, comma separated)",aliases_placeholder:"e.g.: doing, done, did",definition_placeholder:"Enter word definition...",add_button:"Add",save_button:"Save",cancel_button:"Cancel",select_canvas_file:"Select vocabulary book file",delete_confirmation:`Are you sure you want to delete the word "{0}"?
This action cannot be undone.`}};var ne={plugin_name:"\u751F\u8BCD\u672C",settings:{vocabulary_books:"\u751F\u8BCD\u672C",add_vocabulary_book:"\u6DFB\u52A0\u751F\u8BCD\u672C",remove_vocabulary_book:"\u79FB\u9664",show_definition_on_hover:"\u60AC\u505C\u663E\u793A\u91CA\u4E49",show_definition_on_hover_desc:"\u9F20\u6807\u60AC\u505C\u5728\u9AD8\u4EAE\u8BCD\u6C47\u4E0A\u65F6\u663E\u793A\u5B9A\u4E49",enable_auto_highlight:"\u542F\u7528\u81EA\u52A8\u9AD8\u4EAE",enable_auto_highlight_desc:"\u5728\u9605\u8BFB\u65F6\u81EA\u52A8\u9AD8\u4EAE\u751F\u8BCD\u672C\u4E2D\u7684\u8BCD\u6C47",highlight_style:"\u9AD8\u4EAE\u6837\u5F0F",highlight_style_desc:"\u9009\u62E9\u5355\u8BCD\u5728\u6587\u672C\u4E2D\u7684\u9AD8\u4EAE\u663E\u793A\u65B9\u5F0F",style_underline:"\u4E0B\u5212\u7EBF",style_background:"\u80CC\u666F\u9AD8\u4EAE",style_bold:"\u7C97\u4F53",style_dotted:"\u70B9\u72B6\u4E0B\u5212\u7EBF",style_wavy:"\u6CE2\u6D6A\u7EBF",save_settings:"\u4FDD\u5B58\u8BBE\u7F6E",no_vocabulary_books:"\u6682\u65E0\u751F\u8BCD\u672C\uFF0C\u8BF7\u6DFB\u52A0 Canvas \u6587\u4EF6\u4F5C\u4E3A\u751F\u8BCD\u672C",path:"\u8DEF\u5F84",reload_book:"\u91CD\u65B0\u89E3\u6790\u8BE5\u751F\u8BCD\u672C",statistics:"\u7EDF\u8BA1\u4FE1\u606F",total_books:"\u603B\u751F\u8BCD\u672C\u6570\u91CF: {0}",enabled_books:"\u5DF2\u542F\u7528\u751F\u8BCD\u672C: {0}",total_words:"\u603B\u8BCD\u6C47\u6570\u91CF: {0}",enable_mastered_feature:"\u542F\u7528\u5DF2\u638C\u63E1\u529F\u80FD",enable_mastered_feature_desc:"\u6807\u8BB0\u5DF2\u638C\u63E1\u5355\u8BCD\u4EE5\u505C\u6B62\u9AD8\u4EAE\u663E\u793A\u3002\u4FA7\u8FB9\u680F\u663E\u793A\u5206\u7EC4\u5355\u8BCD",blur_definitions:"\u6A21\u7CCA\u5185\u5BB9",blur_definitions_desc:"\u9ED8\u8BA4\u6A21\u7CCA\u663E\u793A\u5185\u5BB9\uFF0C\u9F20\u6807\u60AC\u505C\u65F6\u663E\u793A\u6E05\u6670\u5185\u5BB9\u3002\u9002\u5408\u5B66\u4E60\u65F6\u5148\u56DE\u5FC6\u518D\u67E5\u770B\u7B54\u6848"},sidebar:{title:"HiWords",empty_state:"\u672A\u627E\u5230\u5355\u8BCD\u3002\u6DFB\u52A0\u5355\u8BCD\u5230\u60A8\u7684\u751F\u8BCD\u672C\u4EE5\u5728\u6B64\u5904\u67E5\u770B\u3002",source_prefix:"\u6765\u81EA: ",found:"\u53D1\u73B0",words:"\u4E2A\u751F\u8BCD",no_definition:"\u6682\u65E0\u5B9A\u4E49",vocabulary_book:"\u8BCD\u6C47",mastered:"\u5DF2\u638C\u63E1",no_learning_words:"\u6CA1\u6709\u5F85\u5B66\u4E60\u7684\u5355\u8BCD",no_mastered_words:"\u6CA1\u6709\u5DF2\u638C\u63E1\u7684\u5355\u8BCD"},commands:{refresh_vocabulary:"\u5237\u65B0\u751F\u8BCD\u672C",add_word:"HiWords: \u6DFB\u52A0\u5355\u8BCD",edit_word:"HiWords: \u7F16\u8F91\u5355\u8BCD",show_sidebar:"\u663E\u793A HiWords \u4FA7\u8FB9\u680F"},notices:{vocabulary_refreshed:"\u751F\u8BCD\u672C\u5DF2\u5237\u65B0",word_added:"\u5355\u8BCD\u5DF2\u6DFB\u52A0\u5230\u751F\u8BCD\u672C",word_exists:"\u5355\u8BCD\u5DF2\u5B58\u5728\u4E8E\u751F\u8BCD\u672C\u4E2D",error_adding_word:"\u6DFB\u52A0\u5355\u8BCD\u5230\u751F\u8BCD\u672C\u65F6\u51FA\u9519",select_book_required:"\u8BF7\u9009\u62E9\u751F\u8BCD\u672C",adding_word:"\u6B63\u5728\u6DFB\u52A0\u8BCD\u6C47\u5230\u751F\u8BCD\u672C...",updating_word:"\u6B63\u5728\u66F4\u65B0\u8BCD\u6C47...",word_added_success:'\u8BCD\u6C47 "{0}" \u5DF2\u6210\u529F\u6DFB\u52A0\u5230\u751F\u8BCD\u672C',word_updated_success:'\u8BCD\u6C47 "{0}" \u5DF2\u6210\u529F\u66F4\u65B0',add_word_failed:"\u6DFB\u52A0\u8BCD\u6C47\u5931\u8D25\uFF0C\u8BF7\u68C0\u67E5\u751F\u8BCD\u672C\u6587\u4EF6",update_word_failed:"\u66F4\u65B0\u8BCD\u6C47\u5931\u8D25\uFF0C\u8BF7\u68C0\u67E5\u751F\u8BCD\u672C\u6587\u4EF6",error_processing_word:"\u5904\u7406\u8BCD\u6C47\u65F6\u51FA\u9519",no_canvas_files:"\u672A\u627E\u5230 Canvas \u6587\u4EF6",book_already_exists:"\u8BE5\u751F\u8BCD\u672C\u5DF2\u5B58\u5728",invalid_canvas_file:"\u65E0\u6548\u7684 Canvas \u6587\u4EF6",book_added:"\u5DF2\u6DFB\u52A0\u751F\u8BCD\u672C: {0}",book_reloaded:"\u5DF2\u91CD\u65B0\u52A0\u8F7D: {0}",book_removed:"\u5DF2\u5220\u9664\u751F\u8BCD\u672C: {0}",deleting_word:"\u6B63\u5728\u5220\u9664\u8BCD\u6C47...",word_deleted:"\u8BCD\u6C47\u5DF2\u5220\u9664",delete_word_failed:"\u5220\u9664\u8BCD\u6C47\u5931\u8D25\uFF0C\u8BF7\u68C0\u67E5\u751F\u8BCD\u672C\u6587\u4EF6",error_deleting_word:"\u5220\u9664\u8BCD\u6C47\u65F6\u53D1\u751F\u9519\u8BEF",mastered_feature_disabled:"\u5DF2\u638C\u63E1\u529F\u80FD\u672A\u542F\u7528",update_word_status_failed:"\u66F4\u65B0\u5355\u8BCD\u72B6\u6001\u5931\u8D25",move_to_mastered_group_failed:"\u79FB\u52A8\u5230\u5DF2\u638C\u63E1\u5206\u7EC4\u5931\u8D25",word_marked_as_mastered:'"{0}"\u5DF2\u6807\u8BB0\u4E3A\u5DF2\u638C\u63E1',mark_mastered_failed:"\u6807\u8BB0\u5931\u8D25\uFF0C\u8BF7\u91CD\u8BD5",remove_from_mastered_group_failed:"\u4ECE\u5DF2\u638C\u63E1\u5206\u7EC4\u79FB\u9664\u5931\u8D25",word_unmarked_as_mastered:'"{0}"\u5DF2\u53D6\u6D88\u5DF2\u638C\u63E1\u6807\u8BB0',unmark_mastered_failed:"\u53D6\u6D88\u6807\u8BB0\u5931\u8D25\uFF0C\u8BF7\u91CD\u8BD5",batch_marked_success:"\u6210\u529F\u6807\u8BB0 {0} \u4E2A\u5355\u8BCD\u4E3A\u5DF2\u638C\u63E1"},modals:{add_word_title:"\u6DFB\u52A0 ",edit_word_title:"\u7F16\u8F91 ",word_label:"\u8BCD\u6C47",definition_label:"\u91CA\u4E49",book_label:"\u751F\u8BCD\u672C",select_book:"\u9009\u62E9\u751F\u8BCD\u672C",color_label:"\u5361\u7247\u989C\u8272",color_gray:"\u7070\u8272",color_red:"\u7EA2\u8272",color_orange:"\u6A59\u8272",color_yellow:"\u9EC4\u8272",color_green:"\u7EFF\u8272",color_blue:"\u84DD\u8272",color_purple:"\u7D2B\u8272",aliases_label:"\u522B\u540D\uFF08\u53EF\u9009\uFF0C\u7528\u9017\u53F7\u5206\u9694\uFF09",aliases_placeholder:"\u4F8B\u5982\uFF1Adoing, done, did",definition_placeholder:"\u8F93\u5165\u8BCD\u6C47\u91CA\u4E49...",add_button:"\u6DFB\u52A0",save_button:"\u4FDD\u5B58",cancel_button:"\u53D6\u6D88",select_canvas_file:"\u9009\u62E9 Canvas \u6587\u4EF6",delete_confirmation:`\u786E\u5B9A\u8981\u5220\u9664\u8BCD\u6C47 "{0}" \u5417\uFF1F
\u6B64\u64CD\u4F5C\u4E0D\u53EF\u64A4\u9500\u3002`}};var ve={en:ae,zh:ne},te=class p{constructor(){this.app=null}static getInstance(){return p.instance||(p.instance=new p),p.instance}setApp(e){this.app=e}getCurrentLocale(){return(window.localStorage.getItem("language")||"en").startsWith("zh")?"zh":"en"}t(e){let t=this.getCurrentLocale(),i=ve[t],r=e.split("."),o=i;for(let s of r)if(o&&o[s]!==void 0)o=o[s];else return console.warn(`\u7FFB\u8BD1\u952E ${e} \u4E0D\u5B58\u5728\u4E8E ${t} \u8BED\u8A00\u5305\u4E2D`),e;return o}},ie=te.getInstance(),n=p=>ie.t(p);var F=class{constructor(e,t){this.plugin=e,this.vocabularyManager=t,this.masteredGroupManager=new $(e.app)}get isEnabled(){return this.plugin.settings.enableMasteredFeature}async markWordAsMastered(e,t,i){if(!this.isEnabled)return new C.Notice(n("notices.mastered_feature_disabled")),!1;try{return await this.updateWordMasteredStatus(e,t,!0)?await this.masteredGroupManager.moveToMasteredGroup(e,t)?(this.plugin.refreshHighlighter(),this.plugin.app.workspace.trigger("hi-words:mastered-changed"),new C.Notice(n("notices.word_marked_as_mastered").replace("{0}",i)),!0):(await this.updateWordMasteredStatus(e,t,!1),new C.Notice(n("notices.move_to_mastered_group_failed")),!1):(new C.Notice(n("notices.update_word_status_failed")),!1)}catch(r){return console.error("\u6807\u8BB0\u5DF2\u638C\u63E1\u5931\u8D25:",r),new C.Notice(n("notices.mark_mastered_failed")),!1}}async unmarkWordAsMastered(e,t,i){if(!this.isEnabled)return new C.Notice(n("notices.mastered_feature_disabled")),!1;try{return await this.updateWordMasteredStatus(e,t,!1)?await this.masteredGroupManager.removeFromMasteredGroup(e,t)?(this.plugin.refreshHighlighter(),this.plugin.app.workspace.trigger("hi-words:mastered-changed"),new C.Notice(n("notices.word_unmarked_as_mastered").replace("{0}",i)),!0):(await this.updateWordMasteredStatus(e,t,!0),new C.Notice(n("notices.remove_from_mastered_group_failed")),!1):(new C.Notice(n("notices.update_word_status_failed")),!1)}catch(r){return console.error("\u53D6\u6D88\u5DF2\u638C\u63E1\u6807\u8BB0\u5931\u8D25:",r),new C.Notice(n("notices.unmark_mastered_failed")),!1}}async isWordMastered(e,t){if(!this.isEnabled)return!1;try{let i=await this.vocabularyManager.getWordDefinitionByNodeId(e,t);return(i==null?void 0:i.mastered)===!0}catch(i){return console.error("\u68C0\u67E5\u5355\u8BCD\u638C\u63E1\u72B6\u6001\u5931\u8D25:",i),!1}}async getMasteredWords(e){if(!this.isEnabled)return[];try{return(await this.vocabularyManager.getAllWordDefinitions()).filter(i=>!(!i.mastered||e&&i.source!==e))}catch(t){return console.error("\u83B7\u53D6\u5DF2\u638C\u63E1\u5355\u8BCD\u5217\u8868\u5931\u8D25:",t),[]}}async getMasteredStats(){if(!this.isEnabled)return{totalMastered:0,totalWords:0,masteredPercentage:0,byBook:{}};try{let e=await this.vocabularyManager.getAllWordDefinitions(),t=e.filter(r=>r.mastered),i={};return e.forEach(r=>{i[r.source]||(i[r.source]={mastered:0,total:0}),i[r.source].total++,r.mastered&&i[r.source].mastered++}),{totalMastered:t.length,totalWords:e.length,masteredPercentage:e.length>0?t.length/e.length*100:0,byBook:i}}catch(e){return console.error("\u83B7\u53D6\u5DF2\u638C\u63E1\u7EDF\u8BA1\u4FE1\u606F\u5931\u8D25:",e),{totalMastered:0,totalWords:0,masteredPercentage:0,byBook:{}}}}async batchMarkAsMastered(e){if(!this.isEnabled)return 0;let t=0;for(let i of e)await this.markWordAsMastered(i.bookPath,i.nodeId,i.word)&&t++;return t>0&&new C.Notice(n("notices.batch_marked_success").replace("{0}",t.toString())),t}async updateWordMasteredStatus(e,t,i){try{let r=await this.vocabularyManager.getWordDefinitionByNodeId(e,t);return r?(r.mastered=i,await this.vocabularyManager.updateWordDefinition(e,t,r),!0):(console.error(`\u672A\u627E\u5230\u5355\u8BCD\u5B9A\u4E49: ${t}`),!1)}catch(r){return console.error("\u66F4\u65B0\u5355\u8BCD\u638C\u63E1\u72B6\u6001\u5931\u8D25:",r),!1}}async syncMasteredStatus(e){if(this.isEnabled)try{let t=await this.vocabularyManager.getWordDefinitionsByBook(e);for(let i of t){let r=await this.masteredGroupManager.isNodeInMasteredGroup(e,i.nodeId);i.mastered&&!r?await this.masteredGroupManager.moveToMasteredGroup(e,i.nodeId):!i.mastered&&r&&await this.masteredGroupManager.removeFromMasteredGroup(e,i.nodeId)}}catch(t){console.error("\u540C\u6B65\u5DF2\u638C\u63E1\u72B6\u6001\u5931\u8D25:",t)}}};var V=require("@codemirror/state"),T=require("@codemirror/view");var G=class{constructor(){this.root=new O}addWord(e,t){let i=this.root,r=e.toLowerCase();for(let o of r)i.children.has(o)||i.children.set(o,new O),i=i.children.get(o);i.isEndOfWord=!0,i.payload=t,i.word=e}findAllMatches(e){let t=[],i=e.toLowerCase();for(let r=0;r<i.length;r++){let o=this.root,s=r;for(;s<i.length&&o.children.has(i[s]);)if(o=o.children.get(i[s]),s++,o.isEndOfWord){let a=r===0||!le(i[r-1]),c=s===i.length||!le(i[s]);a&&c&&t.push({word:o.word||i.substring(r,s),from:r,to:s,payload:o.payload})}}return t}clear(){this.root=new O}},O=class{constructor(){this.children=new Map,this.isEndOfWord=!1,this.payload=null,this.word=null}};function le(p){return/[a-z0-9]/i.test(p)}function R(p,e="var(--color-accent)"){return p?{1:"var(--color-red)",2:"var(--color-orange)",3:"var(--color-yellow)",4:"var(--color-green)",5:"var(--color-cyan)",6:"var(--color-purple)",red:"var(--color-red)",orange:"var(--color-orange)",yellow:"var(--color-yellow)",green:"var(--color-green)",cyan:"var(--color-cyan)",blue:"var(--color-blue)",purple:"var(--color-purple)",pink:"var(--color-pink)",gray:"var(--color-base-60)",grey:"var(--color-base-60)",white:"var(--color-base-00)",black:"var(--color-base-100)"}[p.toLowerCase()]||p:e}function de(p,e=.1){return p.startsWith("var(--color-")?`color-mix(in srgb, ${p} ${e*100}%, transparent)`:p.startsWith("#")||p.startsWith("rgb")||p.startsWith("hsl")?`color-mix(in srgb, ${p} ${e*100}%, transparent)`:p}var we=300;var ce=V.StateEffect.define(),re=class p{constructor(){this.highlighters=new Set}static getInstance(){return p.instance||(p.instance=new p),p.instance}register(e){this.highlighters.add(e)}unregister(e){this.highlighters.delete(e)}refreshAll(){this.highlighters.forEach(e=>{try{e.forceUpdate()}catch(t){console.error("\u5237\u65B0\u9AD8\u4EAE\u5668\u5931\u8D25:",t)}})}clear(){this.highlighters.clear()}},A=re.getInstance(),ye=V.StateField.define({create(){return T.Decoration.none},update(p,e){p=p.map(e.changes);for(let t of e.effects)if(t.is(ce))return T.Decoration.none;return p},provide:p=>T.EditorView.decorations.from(p)}),q=class{constructor(e,t){this.debounceTimer=null;this.lastRanges=[];this.cachedMatches=new Map;this.editorView=e,this.vocabularyManager=t,this.wordTrie=new G,this.buildWordTrie(),this.decorations=this.buildDecorations(e),A.register(this)}buildWordTrie(){let e=performance.now();this.wordTrie.clear();let t=this.vocabularyManager.getAllWordsForHighlight();for(let i of t){let r=this.vocabularyManager.getDefinition(i);r&&this.wordTrie.addWord(i,r)}}update(e){(e.docChanged||e.viewportChanged||e.focusChanged)&&this.debouncedUpdate(e.view)}forceUpdate(){this.buildWordTrie(),this.cachedMatches.clear(),this.decorations=this.buildDecorations(this.editorView),this.editorView.dispatch({effects:ce.of(!0)})}debouncedUpdate(e){this.debounceTimer&&window.clearTimeout(this.debounceTimer),this.debounceTimer=window.setTimeout(()=>{this.decorations=this.buildDecorations(e),this.debounceTimer=null},we)}buildDecorations(e){let t=performance.now(),i=new V.RangeSetBuilder,r=[],o=e.visibleRanges,s=this.haveRangesChanged(o),a=o.map(d=>`${d.from}-${d.to}`).join(",");if(!s&&this.cachedMatches.has(a)){let d=this.cachedMatches.get(a);return this.applyDecorations(i,d),i.finish()}this.lastRanges=o.map(d=>({from:d.from,to:d.to}));for(let{from:d,to:h}of e.visibleRanges){let u=e.state.sliceDoc(d,h);r.push(...this.findWordMatches(u,d))}r.sort((d,h)=>d.from-h.from);let c=this.removeOverlaps(r);return this.cachedMatches.set(a,c),this.applyDecorations(i,c),i.finish()}applyDecorations(e,t){let i=this.vocabularyManager.getSettings().highlightStyle||"underline";t.forEach(r=>{let o=R(r.definition.color,"var(--color-base-60)");e.add(r.from,r.to,T.Decoration.mark({class:"hi-words-highlight",attributes:{"data-word":r.word,"data-definition":r.definition.definition,"data-color":o,"data-style":i,style:`--word-highlight-color: ${o};`}}))})}haveRangesChanged(e){if(this.lastRanges.length!==e.length)return!0;for(let t=0;t<e.length;t++)if(e[t].from!==this.lastRanges[t].from||e[t].to!==this.lastRanges[t].to)return!0;return!1}findWordMatches(e,t){let i=performance.now(),r=[];try{let o=this.wordTrie.findAllMatches(e);for(let s of o){let a=s.payload;a&&r.push({word:s.word,definition:a,from:t+s.from,to:t+s.to,color:R(a.color,"var(--color-accent)")})}}catch(o){console.error("\u5728 findWordMatches \u4E2D\u53D1\u751F\u9519\u8BEF:",o)}return r}removeOverlaps(e){return e}escapeRegExp(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}destroy(){this.debounceTimer&&(window.clearTimeout(this.debounceTimer),this.debounceTimer=null),this.cachedMatches.clear(),this.wordTrie.clear(),A.unregister(this)}};function oe(p){let e={decorations:i=>i.decorations};class t extends q{constructor(r){super(r,p)}}return[ye,T.ViewPlugin.fromClass(t,e)]}var b=require("obsidian");var B="hi-words-sidebar",U=class extends b.ItemView{constructor(t,i){super(t);this.currentWords=[];this.activeTab="learning";this.currentFile=null;this.lastActiveMarkdownView=null;this.plugin=i}getViewType(){return B}getDisplayText(){return n("sidebar.title")}getIcon(){return"book-open"}async onOpen(){let t=this.containerEl.children[1];t.empty(),t.addClass("hi-words-sidebar"),this.updateView(),this.registerEvent(this.app.workspace.on("active-leaf-change",()=>{this.updateView()})),this.registerEvent(this.app.workspace.on("editor-change",()=>{setTimeout(()=>this.updateView(),500)})),this.registerEvent(this.app.vault.on("modify",i=>{i instanceof b.TFile&&i.extension==="canvas"&&setTimeout(()=>this.updateView(),200)})),this.registerEvent(this.app.workspace.on("hi-words:mastered-changed",()=>{this.updateView()})),this.registerEvent(this.app.workspace.on("hi-words:settings-changed",()=>{this.updateView()}))}async onClose(){}async updateView(){let t=this.app.workspace.getActiveFile();if(!t||t.extension!=="md"){this.showEmptyState("\u8BF7\u6253\u5F00\u4E00\u4E2A Markdown \u6587\u6863");return}let i=this.app.workspace.getActiveViewOfType(b.MarkdownView);i&&(this.lastActiveMarkdownView=i),!(t===this.currentFile&&this.currentWords.length>0)&&(this.currentFile=t,await this.scanCurrentDocument(),this.renderWordList())}async scanCurrentDocument(){if(this.currentFile)try{let t=await this.app.vault.read(this.currentFile),i=await this.plugin.vocabularyManager.getAllWordDefinitions(),r=[];for(let o of i){let s=new RegExp(`\\b${this.escapeRegExp(o.word)}\\b`,"gi"),a=s.exec(t),c=a?a.index:-1;if(c===-1&&o.aliases){for(let d of o.aliases)if(s=new RegExp(`\\b${this.escapeRegExp(d)}\\b`,"gi"),a=s.exec(t),a){c=a.index;break}}c!==-1&&(r.some(d=>d.wordDef.nodeId===o.nodeId)||r.push({wordDef:o,position:c}))}r.sort((o,s)=>o.position-s.position),this.currentWords=r.map(o=>o.wordDef)}catch(t){console.error("Failed to scan document:",t),this.currentWords=[]}}renderWordList(){let t=this.containerEl.querySelector(".hi-words-sidebar");if(!t)return;if(t.empty(),this.currentWords.length===0){this.showEmptyState(n("sidebar.empty_state"));return}let i=this.currentWords.filter(o=>!o.mastered),r=this.currentWords.filter(o=>o.mastered);this.activeTab==="learning"&&i.length===0&&r.length>0&&(this.activeTab="mastered"),this.createTabNavigation(t,i.length,r.length),this.createTabContent(t,i,r)}createTabNavigation(t,i,r){let o=t.createEl("div",{cls:"hi-words-tab-nav"}),s=o.createEl("div",{cls:`hi-words-tab ${this.activeTab==="learning"?"active":""}`,attr:{"data-tab":"learning"}});if(s.createEl("span",{text:`${n("sidebar.vocabulary_book")} (${i})`}),this.plugin.settings.enableMasteredFeature){let a=o.createEl("div",{cls:`hi-words-tab ${this.activeTab==="mastered"?"active":""}`,attr:{"data-tab":"mastered"}});a.createEl("span",{text:`${n("sidebar.mastered")} (${r})`}),a.addEventListener("click",()=>{this.switchTab("mastered")})}s.addEventListener("click",()=>{this.switchTab("learning")})}createTabContent(t,i,r){this.activeTab==="learning"?i.length>0?this.createWordList(t,i,!1):this.createEmptyState(t,n("sidebar.no_learning_words")):this.activeTab==="mastered"&&(r.length>0?this.createWordList(t,r,!0):this.createEmptyState(t,n("sidebar.no_mastered_words")))}switchTab(t){this.activeTab!==t&&(this.activeTab=t,this.renderWordList())}createWordList(t,i,r){let o=t.createEl("div",{cls:"hi-words-word-list"});i.forEach(s=>{this.createWordCard(o,s,r)})}createWordSection(t,i,r,o,s){let a=t.createEl("div",{cls:s?"hi-words-mastered-section":"hi-words-section"}),c=a.createEl("div",{cls:"hi-words-section-title"}),d=c.createEl("span",{cls:"hi-words-section-icon"});(0,b.setIcon)(d,o),c.createEl("span",{text:`${i} (${r.length})`,cls:"hi-words-section-text"});let h=a.createEl("div",{cls:"hi-words-word-list"});r.forEach(u=>{this.createWordCard(h,u,s)})}createWordCard(t,i,r=!1){let o=t.createEl("div",{cls:"hi-words-word-card"}),s=R(i.color,"var(--color-base-60)");if(o.style.borderLeftColor=s,i.color){o.style.setProperty("--word-card-accent-color",s);let h=de(s,.1);o.style.setProperty("--word-card-bg-color",h)}let a=o.createEl("div",{cls:"hi-words-word-title"});if(a.createEl("span",{text:i.word,cls:"hi-words-word-text"}),this.plugin.settings.enableMasteredFeature&&this.plugin.masteredService){let h=a.createEl("div",{cls:"hi-words-title-mastered-button",attr:{"aria-label":r?"\u5FD8\u8BB0\u4E86":"\u5DF2\u638C\u63E1"}});(0,b.setIcon)(h,r?"frown":"smile"),h.addEventListener("click",async u=>{u.stopPropagation();try{r?await this.plugin.masteredService.unmarkWordAsMastered(i.source,i.nodeId,i.word):await this.plugin.masteredService.markWordAsMastered(i.source,i.nodeId,i.word),setTimeout(()=>this.updateView(),100)}catch(l){console.error("\u5207\u6362\u5DF2\u638C\u63E1\u72B6\u6001\u5931\u8D25:",l)}})}if(i.definition&&i.definition.trim()){let u=o.createEl("div",{cls:"hi-words-word-definition"}).createEl("div",{cls:this.plugin.settings.blurDefinitions?"hi-words-definition blur-enabled":"hi-words-definition"});try{let l=this.app.workspace.getActiveViewOfType(b.MarkdownView)||this.lastActiveMarkdownView;l&&l.file?b.MarkdownRenderer.renderMarkdown(i.definition,u,l.file.path,l):u.textContent=i.definition}catch(l){console.error("Markdown \u6E32\u67D3\u5931\u8D25:",l),u.textContent=i.definition}}let c=o.createEl("div",{cls:"hi-words-word-source"}),d=this.getBookNameFromPath(i.source);c.createEl("span",{text:`${n("sidebar.source_prefix")}${d}`,cls:"hi-words-source-text"}),c.style.cursor="pointer",c.addEventListener("click",h=>{h.stopPropagation(),this.navigateToSource(i)}),r&&o.addClass("hi-words-word-card-mastered")}createEmptyState(t,i){t.createEl("div",{cls:"hi-words-empty-state"}).createEl("div",{text:i,cls:"hi-words-empty-text"})}showEmptyState(t){let i=this.containerEl.querySelector(".hi-words-sidebar");if(!i)return;i.empty(),i.createEl("div",{cls:"hi-words-empty-state"}).createEl("div",{text:t,cls:"hi-words-empty-text"})}getBookNameFromPath(t){var r;let i=this.plugin.settings.vocabularyBooks.find(o=>o.path===t);return i?i.name:((r=t.split("/").pop())==null?void 0:r.replace(".canvas",""))||"\u672A\u77E5"}truncateText(t,i){return t.length<=i?t:t.substring(0,i).trim()}escapeRegExp(t){return t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}async navigateToSource(t){try{let i=this.app.vault.getAbstractFileByPath(t.source);i instanceof b.TFile&&(i.extension==="canvas"?await this.app.workspace.openLinkText(i.path,""):(await this.app.workspace.openLinkText(i.path,""),setTimeout(()=>{var o;let r=this.app.workspace.getActiveViewOfType(b.MarkdownView);if(r&&((o=r.file)==null?void 0:o.path)===i.path){let s=r.editor,c=s.getValue().toLowerCase().indexOf(t.word.toLowerCase());if(c!==-1){let d=s.offsetToPos(c);s.setCursor(d),s.scrollIntoView({from:d,to:d},!0)}}},100)))}catch(i){console.error("\u5BFC\u822A\u5230\u6E90\u6587\u4EF6\u5931\u8D25:",i)}}async openVocabularyBook(t){let i=this.app.vault.getAbstractFileByPath(t.source);i instanceof b.TFile&&await this.app.workspace.openLinkText(i.path,"")}refresh(){this.currentFile=null,this.updateView()}};var x=require("obsidian");var z=class{constructor(e){this.activeTooltip=null;this.vocabularyManager=null;this.masteredService=null;this.eventHandlers={};this.app=e.app,this.plugin=e,this.eventHandlers={mouseover:this.handleMouseOver.bind(this),mouseout:this.handleMouseOut.bind(this)},this.registerEvents()}simpleMarkdownToHtml(e){return e?e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/^### (.*?)$/gm,"<h3>$1</h3>").replace(/^## (.*?)$/gm,"<h2>$1</h2>").replace(/^# (.*?)$/gm,"<h1>$1</h1>").replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/\*(.*?)\*/g,"<em>$1</em>").replace(/__(.*?)__/g,"<strong>$1</strong>").replace(/_(.*?)_/g,"<em>$1</em>").replace(/\[([^\]]+)\]\(([^\)]+)\)/g,'<a href="$2" target="_blank">$1</a>').replace(/^\* (.*?)$/gm,"<li>$1</li>").replace(/^\d+\. (.*?)$/gm,"<li>$1</li>").replace(/^> (.*?)$/gm,"<blockquote>$1</blockquote>").replace(/`(.*?)`/g,"<code>$1</code>").replace(/\n/g,"<br>"):""}setContentSafely(e,t){for(;e.firstChild;)e.removeChild(e.firstChild);let i=s=>{let a=s.match(/^(#{1,3}) (.+)$/gm);return a&&a.forEach(c=>{let[d,h,u]=c.match(/^(#{1,3}) (.+)$/)||[];if(h&&u){let l=h.length,f=document.createElement(`h${l}`);f.textContent=u,e.appendChild(f),s=s.replace(c,"")}}),s},r=s=>{if(!s.trim())return;s=s.replace(/\*\*(.*?)\*\*/g,(c,d)=>`[STRONG]${d}[/STRONG]`),s=s.replace(/\*(.*?)\*/g,(c,d)=>`[EM]${d}[/EM]`),s=s.replace(/\[([^\]]+)\]\(([^\)]+)\)/g,(c,d,h)=>`[LINK:${h}]${d}[/LINK]`),s=s.replace(/`(.*?)`/g,(c,d)=>`[CODE]${d}[/CODE]`),s.split(`
`).forEach(c=>{if(!c.trim())return;let d=document.createElement("p"),h=c;h=h.replace(/\[STRONG\](.*?)\[\/STRONG\]/g,(u,l)=>{let f=document.createElement("strong");return f.textContent=l,d.appendChild(f),""}),h=h.replace(/\[EM\](.*?)\[\/EM\]/g,(u,l)=>{let f=document.createElement("em");return f.textContent=l,d.appendChild(f),""}),h=h.replace(/\[LINK:(.*?)\](.*?)\[\/LINK\]/g,(u,l,f)=>{let g=document.createElement("a");return g.href=l,g.textContent=f,g.target="_blank",d.appendChild(g),""}),h=h.replace(/\[CODE\](.*?)\[\/CODE\]/g,(u,l)=>{let f=document.createElement("code");return f.textContent=l,d.appendChild(f),""}),h.trim()&&d.appendChild(document.createTextNode(h)),d.hasChildNodes()&&e.appendChild(d)})},o=i(t);r(o)}setVocabularyManager(e){this.vocabularyManager=e}setMasteredService(e){this.masteredService=e}registerEvents(){document.addEventListener("mouseover",this.eventHandlers.mouseover),document.addEventListener("mouseout",this.eventHandlers.mouseout)}handleMouseOut(e){clearTimeout(this.tooltipHideTimeout);let t=e.target,i=e.relatedTarget;i&&this.activeTooltip&&(i===this.activeTooltip||this.activeTooltip.contains(i))||t&&i&&t.classList.contains("hi-words-highlight")&&i.classList.contains("hi-words-highlight")||t&&this.activeTooltip&&this.activeTooltip.contains(t)&&i&&i.classList.contains("hi-words-highlight")||(this.tooltipHideTimeout=window.setTimeout(()=>{this.removeTooltip()},80))}handleMouseOver(e){let t=e.target;if(t&&t.classList.contains("hi-words-highlight")){let i=t.getAttribute("data-word"),r=t.getAttribute("data-definition");i&&r&&this.createTooltip(t,i,r)}}createTooltip(e,t,i){this.removeTooltip();let r=document.createElement("div");r.className="hi-words-tooltip";let o=document.createElement("div");o.className="hi-words-tooltip-title-container";let s=document.createElement("div");s.className="hi-words-tooltip-title",s.textContent=t,o.appendChild(s),r.appendChild(o);let a=document.createElement("div");if(a.className="hi-words-tooltip-content",this.plugin.settings.blurDefinitions?a.classList.add("hi-words-definition","blur-enabled"):a.classList.add("hi-words-definition"),!i||i.trim()==="")a.textContent=n("sidebar.no_definition");else try{let u=this.app.workspace.getActiveViewOfType(x.MarkdownView);if(u&&u.file)x.MarkdownRenderer.renderMarkdown(i,a,u.file.path,u);else{let l=this.simpleMarkdownToHtml(i);this.setContentSafely(a,l)}}catch(u){console.error("Markdown \u6E32\u67D3\u5931\u8D25:",u),a.textContent=i}if(r.appendChild(a),this.vocabularyManager){let u=this.vocabularyManager.getDefinition(t);if(u&&u.source){if(this.masteredService&&this.masteredService.isEnabled){let w=document.createElement("div");w.className="hi-words-tooltip-title-mastered-button",(0,x.setIcon)(w,u.mastered?"frown":"smile"),w.addEventListener("click",async M=>{M.stopPropagation();try{u.mastered?await this.masteredService.unmarkWordAsMastered(u.source,u.nodeId,u.word):await this.masteredService.markWordAsMastered(u.source,u.nodeId,u.word),this.removeTooltip()}catch(E){console.error("\u5207\u6362\u5DF2\u638C\u63E1\u72B6\u6001\u5931\u8D25:",E)}}),o.appendChild(w)}let l=document.createElement("div");l.className="hi-words-tooltip-source";let f=u.source.split("/").pop()||"",g=f.endsWith(".canvas")?f.slice(0,-7):f;l.textContent=`${n("sidebar.source_prefix")}${g}`,l.style.cursor="pointer",l.addEventListener("click",w=>{w.stopPropagation(),this.navigateToSource(u),this.removeTooltip()}),r.appendChild(l)}}document.body.appendChild(r);let c=e.getBoundingClientRect(),d=window.pageYOffset||document.documentElement.scrollTop,h=window.pageXOffset||document.documentElement.scrollLeft;r.style.left=c.left+h+"px",r.style.top=c.bottom+d+5+"px",setTimeout(()=>{let u=r.getBoundingClientRect(),l=window.innerWidth;if(u.right>l-10){let f=u.right-l+10;r.style.left=parseFloat(r.style.left)-f+"px"}},0),r.addEventListener("mouseleave",u=>{this.removeTooltip()}),this.activeTooltip=r}removeTooltip(){clearTimeout(this.tooltipHideTimeout),this.activeTooltip&&this.activeTooltip.parentNode&&(this.activeTooltip.parentNode.removeChild(this.activeTooltip),this.activeTooltip=null)}async navigateToSource(e){try{let t=this.app.vault.getAbstractFileByPath(e.source);t instanceof x.TFile&&(t.extension==="canvas"?await this.app.workspace.openLinkText(t.path,""):(await this.app.workspace.openLinkText(t.path,""),setTimeout(()=>{var r;let i=this.app.workspace.getActiveViewOfType(x.MarkdownView);if(i&&((r=i.file)==null?void 0:r.path)===t.path){let o=i.editor,a=o.getValue().toLowerCase().indexOf(e.word.toLowerCase());if(a!==-1){let c=o.offsetToPos(a);o.setCursor(c),o.scrollIntoView({from:c,to:c},!0)}}},100)))}catch(t){console.error("\u5BFC\u822A\u5230\u6E90\u6587\u4EF6\u5931\u8D25:",t)}}unload(){document.removeEventListener("mouseover",this.eventHandlers.mouseover),document.removeEventListener("mouseout",this.eventHandlers.mouseout),this.removeTooltip()}};var y=require("obsidian");var H=class extends y.Modal{constructor(e,t,i,r=!1){super(e),this.plugin=t,this.word=i,this.isEditMode=r,r?this.definition=this.plugin.vocabularyManager.getDefinition(i):this.definition=null}onOpen(){let{contentEl:e}=this;e.empty();let t=this.isEditMode?"modals.edit_word_title":"modals.add_word_title";e.createEl("h2",{text:`${n(t)} "${this.word}"`});let i=e.createDiv({cls:"form-item"});i.createEl("label",{text:n("modals.book_label"),cls:"form-item-label"});let r=i.createEl("select",{cls:"dropdown"});r.createEl("option",{text:n("modals.select_book"),value:""}),this.plugin.settings.vocabularyBooks.forEach(v=>{if(v.enabled){let k=r.createEl("option",{text:v.name,value:v.path});this.isEditMode&&this.definition&&this.definition.source===v.path&&(k.selected=!0)}}),this.isEditMode&&this.definition&&(r.disabled=!0);let o=e.createDiv({cls:"form-item"});o.createEl("label",{text:n("modals.color_label"),cls:"form-item-label"});let s=o.createEl("select",{cls:"dropdown setting-item-select"});s.createEl("option",{text:n("modals.color_gray"),value:""}),[{name:n("modals.color_red"),value:"1"},{name:n("modals.color_orange"),value:"2"},{name:n("modals.color_yellow"),value:"3"},{name:n("modals.color_green"),value:"4"},{name:n("modals.color_blue"),value:"5"},{name:n("modals.color_purple"),value:"6"}].forEach(v=>{let k=s.createEl("option",{text:v.name,value:v.value});this.isEditMode&&this.definition&&this.definition.color===v.value&&(k.selected=!0)});let c=e.createDiv({cls:"form-item"});c.createEl("label",{text:n("modals.aliases_label"),cls:"form-item-label"});let d=c.createEl("input",{type:"text",placeholder:n("modals.aliases_placeholder"),cls:"setting-item-input word-aliases-input"});this.isEditMode&&this.definition&&this.definition.aliases&&this.definition.aliases.length>0&&(d.value=this.definition.aliases.join(", "));let h=e.createDiv({cls:"form-item"});h.createEl("label",{text:n("modals.definition_label"),cls:"form-item-label"});let u=h.createEl("textarea",{placeholder:n("modals.definition_placeholder"),cls:"setting-item-input word-definition-input"});u.rows=5,this.isEditMode&&this.definition&&this.definition.definition&&(u.value=this.definition.definition);let l=e.createDiv({cls:"modal-button-container"}),f=l.createDiv({cls:"button-group-left"});if(this.isEditMode&&this.definition){let v=f.createEl("button",{cls:"delete-word-button"});(0,y.setIcon)(v,"trash"),v.onclick=async()=>{if(!await this.showDeleteConfirmation())return;let S=new y.Notice(n("notices.deleting_word"),0);try{let N=await this.plugin.vocabularyManager.deleteWordFromCanvas(this.definition.source,this.definition.nodeId);S.hide(),N?(new y.Notice(n("notices.word_deleted")),this.plugin.refreshHighlighter(),this.close()):new y.Notice(n("notices.delete_word_failed"))}catch(N){S.hide(),console.error("\u5220\u9664\u8BCD\u6C47\u65F6\u53D1\u751F\u9519\u8BEF:",N),new y.Notice(n("notices.error_deleting_word"))}}}let g=l.createDiv({cls:"button-group-right"}),w=g.createEl("button",{text:n("modals.cancel_button")});w.onclick=()=>this.close();let M=this.isEditMode?"modals.save_button":"modals.add_button",E=g.createEl("button",{text:n(M),cls:"mod-cta"});E.onclick=async()=>{let v=r.value,k=u.value,S=s.value?parseInt(s.value):void 0,N=d.value.trim(),D;if(N&&(D=N.split(",").map(W=>W.trim().toLowerCase()),D=D.filter(W=>W.length>0),D.length===0&&(D=void 0)),!v){new y.Notice(n("notices.select_book_required"));return}let j=this.isEditMode?new y.Notice(n("notices.updating_word"),0):new y.Notice(n("notices.adding_word"),0);try{let W=!1;if(this.isEditMode&&this.definition)if(W=await this.plugin.vocabularyManager.updateWordInCanvas(this.definition.source,this.definition.nodeId,this.word,k,S,D),j.hide(),W){let K=n("notices.word_updated_success").replace("{0}",this.word);new y.Notice(K),this.plugin.refreshHighlighter(),this.close()}else new y.Notice(n("notices.update_word_failed"));else if(W=await this.plugin.vocabularyManager.addWordToCanvas(v,this.word,k,S,D),j.hide(),W){let K=n("notices.word_added_success").replace("{0}",this.word);new y.Notice(K),this.plugin.refreshHighlighter(),this.close()}else new y.Notice(n("notices.add_word_failed"))}catch(W){j.hide(),console.error("Failed to add/update word:",W),new y.Notice(n("notices.error_processing_word"))}}}async showDeleteConfirmation(){return window.confirm(n("modals.delete_confirmation").replace("{0}",this.word))}onClose(){let{contentEl:e}=this;e.empty()}};var m=require("obsidian");var Y=class extends m.PluginSettingTab{constructor(e,t){super(e,t),this.plugin=t}display(){let{containerEl:e}=this;e.empty(),this.addBasicSettings(),this.addVocabularyBooksSection()}addBasicSettings(){let{containerEl:e}=this;new m.Setting(e).setName(n("settings.enable_auto_highlight")).setDesc(n("settings.enable_auto_highlight_desc")).addToggle(t=>t.setValue(this.plugin.settings.enableAutoHighlight).onChange(async i=>{this.plugin.settings.enableAutoHighlight=i,await this.plugin.saveSettings(),this.plugin.refreshHighlighter()})),new m.Setting(e).setName(n("settings.show_definition_on_hover")).setDesc(n("settings.show_definition_on_hover_desc")).addToggle(t=>t.setValue(this.plugin.settings.showDefinitionOnHover).onChange(async i=>{this.plugin.settings.showDefinitionOnHover=i,await this.plugin.saveSettings()})),new m.Setting(e).setName(n("settings.highlight_style")).setDesc(n("settings.highlight_style_desc")).addDropdown(t=>t.addOption("underline",n("settings.style_underline")).addOption("background",n("settings.style_background")).addOption("bold",n("settings.style_bold")).addOption("dotted",n("settings.style_dotted")).addOption("wavy",n("settings.style_wavy")).setValue(this.plugin.settings.highlightStyle).onChange(async i=>{this.plugin.settings.highlightStyle=i,await this.plugin.saveSettings(),this.plugin.refreshHighlighter()})),new m.Setting(e).setName(n("settings.enable_mastered_feature")).setDesc(n("settings.enable_mastered_feature_desc")).addToggle(t=>t.setValue(this.plugin.settings.enableMasteredFeature).onChange(async i=>{this.plugin.settings.enableMasteredFeature=i,this.plugin.settings.showMasteredInSidebar=i,await this.plugin.saveSettings(),this.plugin.refreshHighlighter(),this.plugin.app.workspace.trigger("hi-words:mastered-changed")})),new m.Setting(e).setName(n("settings.blur_definitions")).setDesc(n("settings.blur_definitions_desc")).addToggle(t=>t.setValue(this.plugin.settings.blurDefinitions).onChange(async i=>{this.plugin.settings.blurDefinitions=i,await this.plugin.saveSettings(),this.plugin.app.workspace.trigger("hi-words:settings-changed")}))}addVocabularyBooksSection(){let{containerEl:e}=this;new m.Setting(e).setName(n("settings.vocabulary_books")).setHeading(),new m.Setting(e).setName(n("settings.add_vocabulary_book")).setDesc("").addButton(t=>t.setIcon("plus-circle").setTooltip(n("settings.add_vocabulary_book")).onClick(()=>this.showCanvasFilePicker())),this.displayVocabularyBooks(),this.displayStats()}async showCanvasFilePicker(){let e=this.app.vault.getFiles().filter(i=>i.extension==="canvas");if(e.length===0){new m.Notice(n("notices.no_canvas_files"));return}new se(this.app,e,async i=>{await this.addVocabularyBook(i)}).open()}async addVocabularyBook(e){if(this.plugin.settings.vocabularyBooks.some(s=>s.path===e.path)){new m.Notice(n("notices.book_already_exists"));return}if(!await new _(this.app).validateCanvasFile(e)){new m.Notice(n("notices.invalid_canvas_file"));return}let o={path:e.path,name:e.basename,enabled:!0};this.plugin.settings.vocabularyBooks.push(o),await this.plugin.saveSettings(),await this.plugin.vocabularyManager.loadVocabularyBook(o),this.plugin.refreshHighlighter(),new m.Notice(n("notices.book_added").replace("{0}",o.name)),this.display()}displayVocabularyBooks(){let{containerEl:e}=this;if(this.plugin.settings.vocabularyBooks.length===0){e.createEl("p",{text:n("settings.no_vocabulary_books"),cls:"setting-item-description"});return}this.plugin.settings.vocabularyBooks.forEach((t,i)=>{let r=new m.Setting(e).setName(t.name).setDesc(`${n("settings.path")}: ${t.path}`);r.addButton(o=>o.setIcon("refresh-cw").setTooltip(n("settings.reload_book")).onClick(async()=>{await this.plugin.vocabularyManager.reloadVocabularyBook(t.path),this.plugin.refreshHighlighter(),new m.Notice(n("notices.book_reloaded").replace("{0}",t.name))})),r.addButton(o=>o.setIcon("trash").setTooltip(n("settings.remove_vocabulary_book")).setWarning().onClick(async()=>{this.plugin.settings.vocabularyBooks.splice(i,1),await this.plugin.saveSettings(),await this.plugin.vocabularyManager.loadAllVocabularyBooks(),this.plugin.refreshHighlighter(),new m.Notice(n("notices.book_removed").replace("{0}",t.name)),this.display()})),r.addToggle(o=>o.setValue(t.enabled).onChange(async s=>{t.enabled=s,await this.plugin.saveSettings(),s?await this.plugin.vocabularyManager.loadVocabularyBook(t):await this.plugin.vocabularyManager.loadAllVocabularyBooks(),this.plugin.refreshHighlighter()}))})}displayStats(){let{containerEl:e}=this,t=this.plugin.vocabularyManager.getStats();new m.Setting(e).setName(n("settings.statistics")).setHeading();let i=e.createEl("div",{cls:"hi-words-stats"});i.createEl("p",{text:n("settings.total_books").replace("{0}",t.totalBooks.toString())}),i.createEl("p",{text:n("settings.enabled_books").replace("{0}",t.enabledBooks.toString())}),i.createEl("p",{text:n("settings.total_words").replace("{0}",t.totalWords.toString())})}},se=class extends m.Modal{constructor(e,t,i){super(e),this.files=t,this.onSelect=i}onOpen(){let{contentEl:e}=this;e.empty(),e.createEl("h2",{text:n("modals.select_canvas_file")}),this.files.forEach(t=>{let i=e.createEl("div",{cls:"canvas-picker-item"}),r=i.createEl("div",{text:t.basename,cls:"canvas-picker-name"}),o=i.createEl("div",{text:t.path,cls:"canvas-picker-path"});i.addEventListener("click",()=>{this.onSelect(t),this.close()})})}onClose(){let{contentEl:e}=this;e.empty()}};var be={vocabularyBooks:[],showDefinitionOnHover:!0,enableAutoHighlight:!0,highlightStyle:"underline",enableMasteredFeature:!0,showMasteredInSidebar:!0,blurDefinitions:!1},J=class extends P.Plugin{constructor(){super(...arguments);this.editorExtensions=[];this.highlighterInstance=null;this.sidebarView=null;this.isSidebarInitialized=!1}async onload(){await this.loadSettings(),ie.setApp(this.app),this.vocabularyManager=new I(this.app,this.settings),this.masteredService=new F(this,this.vocabularyManager),this.definitionPopover=new z(this),this.definitionPopover.setVocabularyManager(this.vocabularyManager),this.definitionPopover.setMasteredService(this.masteredService),await this.vocabularyManager.loadAllVocabularyBooks(),this.registerView(B,t=>(this.sidebarView=new U(t,this),this.sidebarView)),this.setupEditorExtensions(),this.registerCommands(),this.registerEvents(),this.addSettingTab(new Y(this.app,this)),this.initializeSidebar(),this.app.workspace.onLayoutReady(async()=>{await this.vocabularyManager.loadAllVocabularyBooks(),this.refreshHighlighter()})}setupEditorExtensions(){if(this.settings.enableAutoHighlight){let t=oe(this.vocabularyManager);this.editorExtensions=[t],this.registerEditorExtension(this.editorExtensions)}}registerCommands(){this.addCommand({id:"refresh-vocabulary",name:n("commands.refresh_vocabulary"),callback:async()=>{await this.vocabularyManager.loadAllVocabularyBooks(),this.refreshHighlighter(),new P.Notice(n("notices.vocabulary_refreshed"))}}),this.addCommand({id:"open-vocabulary-sidebar",name:n("commands.show_sidebar"),callback:()=>{this.activateSidebarView()}})}registerEvents(){let t=new Set,i=null;this.registerEvent(this.app.vault.on("modify",r=>{r instanceof P.TFile&&r.extension==="canvas"&&this.settings.vocabularyBooks.some(s=>s.path===r.path)&&t.add(r.path)})),this.registerEvent(this.app.workspace.on("active-leaf-change",async r=>{let o=this.app.workspace.getActiveFile();if(i&&t.has(i)&&(!o||o.path!==i)&&(await this.vocabularyManager.reloadVocabularyBook(i),this.refreshHighlighter(),t.delete(i)),o&&o.extension==="canvas")i=o.path;else if(i=null,t.size>0){let s=Array.from(t);t.clear();for(let a of s)await this.vocabularyManager.reloadVocabularyBook(a);this.refreshHighlighter()}else setTimeout(()=>this.refreshHighlighter(),100)})),this.registerEvent(this.app.workspace.on("editor-menu",(r,o)=>{let s=o.getSelection();if(s&&s.trim()){let a=s.trim(),c=this.vocabularyManager.hasWord(a);r.addItem(d=>{let h=c?"commands.edit_word":"commands.add_word";d.setTitle(n(h)).onClick(()=>{this.addOrEditWord(a)})})}}))}refreshHighlighter(){this.settings.enableAutoHighlight&&A.refreshAll(),this.sidebarView&&this.sidebarView.refresh()}async initializeSidebar(){this.isSidebarInitialized||this.app.workspace.onLayoutReady(()=>{this.isSidebarInitialized=!0})}async activateSidebarView(){let{workspace:t}=this.app,i=null,r=t.getLeavesOfType(B);r.length>0?i=r[0]:(i=t.getRightLeaf(!1),i&&await i.setViewState({type:B,active:!0})),i&&t.revealLeaf(i)}async loadSettings(){this.settings=Object.assign({},be,await this.loadData())}async saveSettings(){await this.saveData(this.settings),this.vocabularyManager.updateSettings(this.settings)}addOrEditWord(t){this.vocabularyManager.hasWord(t)?new H(this.app,this,t,!0).open():new H(this.app,this,t).open()}onunload(){this.definitionPopover.unload(),this.vocabularyManager.clear(),this.vocabularyManager.destroy&&this.vocabularyManager.destroy(),A.clear()}};
